name: Coverage Check

on:
  pull_request:
    branches: [main, master]

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup environment variables
        run: cp .env.example .env

      - name: Get baseline from main branch
        run: |
          # Fetch main branch
          git fetch origin main
          # Try to get baseline from main, if it doesn't exist use empty baseline
          git show origin/main:coverage-baseline.json > baseline-from-main.json 2>/dev/null || echo '{"lines":"0","functions":"0","branches":"0","statements":"0"}' > baseline-from-main.json
          echo "ğŸ“Š Baseline from main:"
          cat baseline-from-main.json

      - name: Run coverage
        id: run_coverage
        timeout-minutes: 15
        run: |
          set -e  # Exit immediately if coverage fails
          npm run coverage
          echo "âœ… Coverage completed successfully"

      - name: Check coverage against main baseline
        if: success()  # Only run if previous steps succeeded
        run: npm run coverage:check -- --baseline=baseline-from-main.json

      - name: Update baseline if coverage improved
        if: success()  # Only run if coverage check passed
        id: update_baseline
        run: |
          # Parse current and baseline coverage
          CURRENT_LINES=$(node -e "const fs=require('fs'); const lcov=fs.readFileSync('coverage/lcov.info','utf8'); const lines=lcov.split('\n'); let lf=0,lh=0; lines.forEach(l=>{if(l.startsWith('LF:'))lf+=parseInt(l.substring(3));if(l.startsWith('LH:'))lh+=parseInt(l.substring(3))}); console.log((lh/lf*100).toFixed(2))")
          BASELINE_LINES=$(jq -r .lines baseline-from-main.json)

          echo "Current coverage: $CURRENT_LINES%"
          echo "Baseline coverage: $BASELINE_LINES%"

          # Compare coverage (using awk for floating point comparison)
          if awk "BEGIN {exit !($CURRENT_LINES > $BASELINE_LINES)}"; then
            echo "improved=true" >> $GITHUB_OUTPUT
            echo "coverage=$CURRENT_LINES" >> $GITHUB_OUTPUT
            echo "âœ… Coverage improved! Updating baseline..."
            npm run coverage:update-baseline
          else
            echo "improved=false" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Coverage maintained (no baseline update needed)"
          fi

      - name: Commit updated baseline to PR
        if: success() && steps.update_baseline.outputs.improved == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add coverage-baseline.json

          # Only commit if there are actual changes
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit (baseline file unchanged)"
          else
            git commit -m "chore: update coverage baseline to ${{ steps.update_baseline.outputs.coverage }}% [skip ci]

          Coverage improved from baseline.

          [automated update]"
            git push
            echo "âœ… Baseline updated and pushed to PR"
          fi

      - name: Upload coverage report (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
